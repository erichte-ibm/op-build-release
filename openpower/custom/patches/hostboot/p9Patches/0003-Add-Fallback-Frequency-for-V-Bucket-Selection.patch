From dd913c0ad6d342ffca1d97f8c12045e09647c03c Mon Sep 17 00:00:00 2001
From: jim <jim.yuan@supermicro.com>
Date: Fri, 8 Dec 2017 11:58:50 -0800
Subject: [PATCH 3/3] Add Fallback Frequency for #V Bucket Selection

---
 .../hwp/pm/p9_pm_get_poundv_bucket_attr.C          | 40 +++++++++++++++++++++-
 .../xml/attribute_info/pm_plat_attributes.xml      | 22 ++++++++++++
 2 files changed, 61 insertions(+), 1 deletion(-)

diff --git a/src/import/chips/p9/procedures/hwp/pm/p9_pm_get_poundv_bucket_attr.C b/src/import/chips/p9/procedures/hwp/pm/p9_pm_get_poundv_bucket_attr.C
index ec6b75e..f004b9b 100644
--- a/src/import/chips/p9/procedures/hwp/pm/p9_pm_get_poundv_bucket_attr.C
+++ b/src/import/chips/p9/procedures/hwp/pm/p9_pm_get_poundv_bucket_attr.C
@@ -53,11 +53,14 @@ fapi2::ReturnCode p9_pm_get_poundv_bucket_attr(
     uint32_t l_tempVpdSize = 0;
     uint32_t l_vpdSize = 0;
     uint8_t l_eqChipUnitPos = 0;
-    uint8_t l_bucketId;
+    uint8_t l_bucketId = 0xFF;
     uint8_t l_bucketSize = 0;
     uint32_t l_sysNestFreq = 0;
+    uint32_t l_fallbackNestFreq = 0;
     fapi2::voltageBucketData_t* l_currentBucket = NULL;
+    fapi2::voltageBucketData_t* l_fallbackBucket = NULL;
     uint8_t l_numMatches = 0;
+    uint8_t l_numMatchesFallback = 0;
     uint16_t l_pbFreq = 0;
 
     fapi2::MvpdRecord lrpRecord = fapi2::MVPD_RECORD_LAST;
@@ -191,6 +194,13 @@ fapi2::ReturnCode p9_pm_get_poundv_bucket_attr(
                                                     <fapi2::voltageBucketData_t*>
                                                     (l_fullVpdData + POUNDV_BUCKET_OFFSET);
 
+            //see if we have a fall-back frequency to use if we don't
+            // get a match
+            FAPI_TRY(FAPI_ATTR_GET(fapi2::ATTR_FREQ_PB_MHZ_POUNDV_FALLBACK,
+                                   l_sysParent,
+                                   l_fallbackNestFreq));
+
+
             for(int i = 0; i < NUM_BUCKETS; i++)
             {
 #ifndef _BIG_ENDIAN
@@ -219,6 +229,26 @@ fapi2::ReturnCode p9_pm_get_poundv_bucket_attr(
                         l_currentBucket = &l_buckets[i];
                     }
                 }
+                else if(l_pbFreq == l_fallbackNestFreq)
+                {
+                    l_numMatchesFallback++;
+
+                    if(l_numMatchesFallback > 1)
+                    {
+                        FAPI_ERR("p9_pm_get_poundv_bucket_attr::"
+                                 " Multiple buckets (%d) reporting the same nest frequency"
+                                 " Fallback Nest = %d Bucket ID = %d, First Bucket = %d",
+                                 l_numMatchesFallback,
+                                 l_fallbackNestFreq,
+                                 (i + 1),
+                                 l_fallbackBucket);
+
+                    }
+                    else
+                    {
+                        l_fallbackBucket = &l_buckets[i];
+                    }
+                }
 
                 //save FFDC in case we fail
                 l_bucketNestFreqs[i] = l_pbFreq;
@@ -228,6 +258,14 @@ fapi2::ReturnCode p9_pm_get_poundv_bucket_attr(
             {
                 l_bucketId = l_currentBucket->bucketId;
             }
+            else if(l_numMatchesFallback == 1)
+            {
+                FAPI_ERR("p9_pm_get_poundv_bucket_attr::Invalid number of matching "
+                         "nest freqs found for PBFreq=%d. Matches found = %d. But "
+                         "did find a fallback match for Freq=%d",
+                         l_sysNestFreq, l_numMatches, l_fallbackNestFreq );
+                l_bucketId = l_fallbackBucket->bucketId;
+            }
             else
             {
 
diff --git a/src/import/chips/p9/procedures/xml/attribute_info/pm_plat_attributes.xml b/src/import/chips/p9/procedures/xml/attribute_info/pm_plat_attributes.xml
index 4b425fb..b9beea0 100644
--- a/src/import/chips/p9/procedures/xml/attribute_info/pm_plat_attributes.xml
+++ b/src/import/chips/p9/procedures/xml/attribute_info/pm_plat_attributes.xml
@@ -2191,4 +2191,26 @@
     <overrideOnly/>
   </attribute>
   <!-- ********************************************************************* -->
+  <attribute>
+    <id>ATTR_FREQ_PB_MHZ_POUNDV_FALLBACK</id>
+    <targetType>TARGET_TYPE_SYSTEM</targetType>
+    <description>
+      The powerbus frequency that should be used to locate a valid #V bucket
+      in the processor Module VPD if the actual ATTR_FREQ_PB_MHZ value isn't
+      present.
+    </description>
+    <valueType>uint32</valueType>
+    <enum>
+      NO_FALLBACK = 0,
+      1600 = 1600,
+      1866 = 1866,
+      2000 = 2000,
+      2133 = 2133,
+      2400 = 2400
+    </enum>
+    <writeable/>
+    <platInit/>
+    <default>NO_FALLBACK</default>
+  </attribute>
+  <!-- ********************************************************************* -->
 </attributes>
-- 
2.9.2.windows.1

