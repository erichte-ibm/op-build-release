From 0487dbe9bac62fe159b8725d7f439aaa379cde62 Mon Sep 17 00:00:00 2001
From: Jim Yuan <jim.yuan@supermicro.com>
Date: Wed, 19 Apr 2017 18:01:46 -0700
Subject: [PATCH] add VGA handshake with BMC

Signed-off-by: Jim Yuan <jim.yuan@supermicro.com>
[arbab: Regenerate patch against kernel 5.10]
Signed-off-by: Reza Arbab <arbab@linux.ibm.com>
---
 drivers/gpu/drm/ast/ast_main.c | 38 ++++++++++++++++++++++++++++++++++
 1 file changed, 38 insertions(+)

diff --git a/drivers/gpu/drm/ast/ast_main.c b/drivers/gpu/drm/ast/ast_main.c
index 0d163511564e..ca303ec557fd 100644
--- a/drivers/gpu/drm/ast/ast_main.c
+++ b/drivers/gpu/drm/ast/ast_main.c
@@ -26,6 +26,7 @@
  * Authors: Dave Airlie <airlied@redhat.com>
  */
 
+#include <linux/delay.h>
 #include <linux/pci.h>
 
 #include <drm/drm_atomic_helper.h>
@@ -392,6 +393,39 @@ static void ast_device_release(void *data)
 	ast_set_index_reg(ast, AST_IO_CRTC_PORT, 0xa1, 0x04);
 }
 
+static int ast_bmc_handshake(struct ast_private *ast) {
+	const u8 h2s_addr = 0x9a, s2h_addr = 0xd2;
+	const int handshake_timeout = 10000;
+	u8 soc_reg, last_reg;
+	int retries;
+
+	soc_reg = ast_get_index_reg(ast, AST_IO_CRTC_PORT, s2h_addr);
+	pr_info("%s: soc reg: %02x\n", __func__, soc_reg);
+	if (!(soc_reg & 0x1))
+		return 0;
+
+	last_reg = soc_reg;
+
+	ast_set_index_reg(ast, AST_IO_CRTC_PORT, h2s_addr, 0x01);
+
+	for (retries = 0; retries < handshake_timeout; retries++) {
+		soc_reg = ast_get_index_reg(ast, AST_IO_CRTC_PORT, s2h_addr);
+		if (soc_reg != last_reg) {
+			pr_info("%s: change %02x\n", __func__, soc_reg);
+			last_reg = soc_reg;
+		}
+		if (!(soc_reg & 0x1)){
+		    ast_set_index_reg(ast, AST_IO_CRTC_PORT, h2s_addr, 0x00);
+			return 0;
+		}
+
+		msleep(10);
+	}
+
+	DRM_ERROR("Failed to complete BMC handshake");
+	return -EIO;
+}
+
 struct ast_private *ast_device_create(struct drm_driver *drv,
 				      struct pci_dev *pdev,
 				      unsigned long flags)
@@ -432,6 +466,10 @@ struct ast_private *ast_device_create(struct drm_driver *drv,
 
 	ast_detect_chip(dev, &need_post);
 
+	ret = ast_bmc_handshake(ast);
+	if (ret)
+		return ERR_PTR(ret);
+
 	ret = ast_get_dram_info(dev);
 	if (ret)
 		return ERR_PTR(ret);
-- 
2.31.1

